# 認証技術選定ドキュメント

## ✅ 要件
- 対応プラットフォーム: **iOS / Android / Web**
- 対応プロバイダ:
  - Apple ID
  - Google
  - X（旧Twitter）
  - LINE
- バックエンド: **Go（gqlgen）**
- フロントエンド: **React Native（Expo）**
- 制約: **コストをかけない**

---

## ✅ 選定候補と比較

### 1. **Expo公式 `expo-apple-authentication`**
- **概要**: Expo純正、Appleサインインのみ対応。
- **対応範囲**: iOSのみ。
- **メリット**
  - 実装が最速（Expo公式サポート）。
  - ネイティブUI・審査要件クリア済み。
- **デメリット**
  - Android / Web 非対応。
  - 他プロバイダとの統合は自前実装必要。
- **GitHubスター**: Expo本体に含まれる（12k+）。
- **ドキュメント**: 充実（公式ガイドあり）。

---

### 2. **Invertase `react-native-apple-authentication`**
- **概要**: AppleサインインをReact Native向けに提供。
- **対応範囲**: iOS（Web対応は未完）。
- **メリット**
  - FirebaseやAuth0との連携ガイドあり。
  - Expo Bare / Prebuild対応可。
- **デメリット**
  - Expo Managedでは追加設定必須。
- **GitHubスター**: 約 **1.5k**。
- **ドキュメント**: 中～高。

---

### 3. **Firebase Authentication**
- **概要**: Google公式IDaaS、マルチプロバイダ対応。
- **対応範囲**: iOS / Android / Web。
- **メリット**
  - Apple / Google / X 標準サポート。
  - LINEはカスタムプロバイダで追加可能。
  - セッション管理、ユーザーマージが自動。
  - Goサーバで `firebase-admin` SDKにより簡単に検証可能。
- **デメリット**
  - Firebase依存（ベンダーロックイン）。
- **GitHubスター**: Firebase全体で **36k+**。
- **ドキュメント**: 非常に充実、日本語情報あり。
- **コスト**
  - 無料枠：月 **50,000 アクティブユーザー**まで無料。

---

### 4. **Auth0**
- **概要**: エンタープライズ向けIDaaS。
- **対応範囲**: iOS / Android / Web。
- **メリット**
  - OAuth/OIDC準拠、複数プロバイダ統合容易。
  - セキュリティ要件に強い。
- **デメリット**
  - 無料枠：月 **7,000 ユーザー**まで。
  - 超過後のコストが高い。
  - ExpoではWeb認証フロー主体（ネイティブ感低）。
- **GitHubスター**: Auth0関連で **20k+**。
- **ドキュメント**: 非常に充実。

---

## ✅ 比較表

| 方法 | iOS | Android | Web | コスト | 実装難易度 | 柔軟性 |
|------|----|---------|-----|-------|-----------|------|
| expo-apple-authentication | ✅ | ❌ | ❌ | 無料 | ◎ | △ |
| react-native-apple-authentication | ✅ | ❌ | ❌ | 無料 | ○ | △ |
| Firebase Auth | ✅ | ✅ | ✅ | 無料枠大 | ○ | ○ |
| Auth0 | ✅ | ✅ | ✅ | 無料枠少 | △ | ◎ |

---

## ✅ 結論
- **要件: コストをかけずに4プロバイダ統合**  
  → **Firebase Authentication が最適**。

### 選定理由
- Apple / Google / X をネイティブでサポート。
- LINEもカスタムプロバイダで対応可能。
- 無料枠が大きく、運用コストゼロで実現可能。
- Go（gqlgen）との連携も容易（`firebase-admin` SDKでIDトークン検証）。

---

## ✅ 実装方針
1. **Expo（React Native）側**
   - `expo-apple-authentication` or `expo-auth-session` を使い、Appleサインインを実装。
   - Google / X はFirebase SDKで統合。
   - LINEはWebView or OAuthフロー → Firebaseカスタムトークン発行。

2. **Go（gqlgen）サーバ側**
   - Firebase IDトークンをヘッダーで受け取り、`firebase-admin-go` SDKで検証。
   - AppleユーザーID（`sub`）などはFirebase UIDに紐付けて管理。

3. **DB構造**
   - `users` テーブルに自社独自ID + Firebase UID + メールアドレス（任意）。
   - 各種外部IDはFirebase管理に任せる。

---

## ✅ 注意点
- Appleの `sub` は基本固定だが、**ユーザーが連携解除すると変わる** → FirebaseでID統合を利用する。
- LINE対応には **Firebaseカスタム認証** が必要。
- Expo Managed環境では **Apple認証はiOSのみ** → AndroidはGoogleやXを使用。

---

## ✅ 今後の拡張
- Web対応（Firebase Authは既に対応済み）。
- パスワードレス（Email Link）やPhone認証もFirebaseで簡単追加可能。

---

**最終選定:**  
→ **Firebase Authentication を採用し、Apple/Google/X/LINEを統合する。**