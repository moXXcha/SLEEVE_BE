# データベース取り扱いマニュアル

このドキュメントは、AI エージェントがデータベースのスキーマ変更やテーブル作成を行う際の指針と手順を定めたものです。

## 1. DB 作成の方針

- **単一責任の原則:** テーブルは単一の責務を持つように設計してください。
- **正規化:** 原則として第三正規形を目指しますが、パフォーマンスとのトレードオフを考慮し、意図的に非正規化する場合はその理由をドキュメントに残してください。
- **命名規則:** `docs/BE_coding_roles.md` に記載されている命名規則を厳守してください。
- **汎用性:** 将来的な拡張性を考慮し、過度に特定のユースケースに最適化しすぎないように設計してください。
- **認証, user 情報について:** 認証、ユーザーの基本情報は firebase で管理しています。
- **orm:** orm は ent を使用しています

## 2. Schema の位置

- **Entity Schema:** Go のコードベースのスキーマ定義は `ent/schema/` ディレクトリ配下に配置されます。実際のテーブル構造はこれらのファイルによって定義されます。
- **全体スキーマ図:** データベース全体の構造を示すスキーマ図は `docs/db_schema.md` にて、[dbdiagram.io](https://dbdiagram.io) の形式で管理されます。

## 3. 実装手順

データベースのスキーマ変更は、以下の手順を厳密に守って進めてください。

### 手順 1: 現状の把握と不足の特定

- まず `docs/db_schema.md` と `ent/schema/` の内容を確認し、現在のデータベース構成を完全に理解します。
- タスクの要件と照らし合わせ、既存のテーブルに不足しているカラムや、新たに必要なテーブルを特定します。

### 手順 2: 変更方針の策定とドキュメント化

- 追加または変更するテーブルの方針を固めます。
- 以下のテンプレートに従い、変更計画書を `docs/tasks/[JiraのID]_[タスク名]/table_edit_plan.md` というファイル名で作成します。

### 手順 3: 作業者によるレビュー

- 作成した変更計画書 (`table_edit_plan.md`) を作業者（人間）に提示し、レビューを依頼します。
- 承認が得られたら、次のステップに進みます。承認なしにスキーマ変更に着手してはいけません。

### 手順 4: スキーマの更新

- **全体スキーマ図の更新:** 承認された変更計画に基づき、`docs/db_schema.md` のスキーマ図を最新の状態に更新します。
- **Entity Schema の更新:** `ent/schema/` ディレクトリ内の該当するスキーマファイルを変更、または新規に作成します。

---

## 4. 変更計画書テンプレート (`table_edit_plan.md`)

```markdown
# 変更の名前

（例: ユーザープロフィールテーブルの追加）

# 背景

（なぜこの変更が必要なのか、Jira チケットの要件などを基に記述）

# 変更内容

（どのテーブルに何を追加/変更するのか、具体的に記述）

- **テーブル名:** `users`
- **追加カラム:** `profile_image_url (string, nullable)`
- **変更カラム:** `age (int)` -> `birthday (datetime)`

# 影響範囲

（このスキーマ変更によって影響を受ける既存の機能や API、テーブルなどを記述）

# 最終 schema (dbdiagram.io 形式)

（変更後の **テーブル単体** または **関連するテーブル群** のスキーマを dbdiagram.io 形式で記述）

Table users {
id integer [primary key]
username varchar
email varchar
// ... (既存のカラム)
profile_image_url varchar
birthday datetime
}
```
