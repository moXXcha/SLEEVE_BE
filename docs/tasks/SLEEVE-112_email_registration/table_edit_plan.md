# Users テーブル作成計画書

## 変更内容

- **種類**: 新規テーブル作成
- **テーブル名**: users
- **対象Subtask**: SLEEVE-101

## テーブル定義

### カラム一覧

| カラム名 | 型 | NULL許可 | デフォルト値 | 制約 | 説明 |
|---------|---|---------|------------|-----|-----|
| id | int | NO | auto increment | PRIMARY KEY | 内部ID（auto increment、外部には公開しない） |
| public_id | uuid | NO | uuid_generate_v4() | UNIQUE | 公開用ユーザーID（UUID、外部APIで使用） |
| firebase_uid | varchar | NO | - | UNIQUE | Firebase Authentication UID |
| email | varchar | NO | - | UNIQUE | メールアドレス |
| created_at | timestamptz | NO | now() | - | 作成日時 |
| updated_at | timestamptz | NO | now() | - | 更新日時 |
| deleted_at | timestamptz | YES | NULL | - | 論理削除日時 |

### ID設計方針

外部から参照されるテーブル（URLで直接アクセスされるもの、外部APIのレスポンスとして使用されるものなど）では、以下のID設計を採用します：

| カラム名 | 型 | 用途 | 公開 |
|---------|---|------|-----|
| id | int (auto increment) | 内部での参照・外部キー結合に使用 | 非公開 |
| public_id | uuid | 外部API・URLで使用（データ作成時にDBで自動生成） | 公開 |

**理由:**
- **セキュリティ**: auto incrementのIDは連番のため、ユーザー数やデータ量が推測されやすい。UUIDを公開することでこれを防ぐ
- **パフォーマンス**: 内部結合にはintのIDを使用することで、JOINの効率を維持
- **拡張性**: 将来的にシャーディングが必要になった場合、UUIDの方が分散に適している

### インデックス

| インデックス名 | 種類 | カラム | 目的 |
|-------------|------|-------|------|
| users_pkey | PRIMARY KEY | id | 主キー（auto increment） |
| user_public_id | UNIQUE INDEX | public_id | 公開IDでの高速検索と一意性保証 |
| user_firebase_uid | UNIQUE INDEX | firebase_uid | Firebase UIDでの高速検索と一意性保証 |
| user_email | UNIQUE INDEX | email | Emailでの検索性能向上と一意性保証 |
| user_deleted_at | INDEX | deleted_at | 論理削除の検索用 |

### リレーション

現時点ではリレーションなし。今後、以下のテーブルとのリレーションが予想されます：
- `profiles` テーブル（ユーザープロフィール）
- `items` テーブル（出品アイテム）
- `coordinates` テーブル（コーディネート投稿）

---

## 変更理由

### ビジネス要件
- Firebase Authenticationで管理するユーザー情報と、自社DBのユーザー情報を紐付けるため
- Firebase UIDを保存し、自社独自のユーザーIDも発行することで、将来的にFirebaseからの移行も可能にする
- Email認証機能の基盤となるテーブル

### 技術的理由
- 認証技術選定ドキュメント（`docs/prod_docs/技術選定/認証技術選定.md`）に従い、Firebase UIDと自社DBを連携
- Firebase Authenticationは認証のみを担当し、ユーザーに関連するビジネスデータは自社DBで管理
- 論理削除（soft delete）を採用し、ユーザーデータの削除履歴を保持

---

## 影響範囲

### 既存機能への影響
- **影響なし**: 新規テーブルのため、既存機能への影響はありません

### 今後の機能への影響
- **ログイン機能**: このusersテーブルを使用してユーザー認証を行う
- **プロフィール機能**: usersテーブルと1対1のリレーションでprofilesテーブルを作成予定
- **コンテンツ投稿機能**: usersテーブルのidを外部キーとして参照
- **フォロー機能**: usersテーブルを自己結合して実装予定

---

## 実装手順

### 手順 1: ent/schema/user.go の作成

```go
package schema

import (
	"time"

	"entgo.io/ent"
	"entgo.io/ent/schema/field"
	"entgo.io/ent/schema/index"
	"github.com/google/uuid"
)

// User holds the schema definition for the User entity.
type User struct {
	ent.Schema
}

// Fields of the User.
func (User) Fields() []ent.Field {
	return []ent.Field{
		// 内部ID（auto increment、外部には公開しない）
		// entのデフォルトIDはintのauto incrementなので、明示的な定義は不要
		// 公開ID（UUID、外部に公開する）
		field.UUID("public_id", uuid.UUID{}).
			Default(uuid.New).
			Unique().
			Immutable().
			Comment("公開用ユーザーID（UUID）"),
		field.String("firebase_uid").
			NotEmpty().
			Unique().
			Comment("Firebase Authentication UID"),
		field.String("email").
			NotEmpty().
			Unique().
			Comment("メールアドレス"),
		field.Time("created_at").
			Default(time.Now).
			Immutable().
			Comment("作成日時"),
		field.Time("updated_at").
			Default(time.Now).
			UpdateDefault(time.Now).
			Comment("更新日時"),
		field.Time("deleted_at").
			Optional().
			Nillable().
			Comment("削除日時（論理削除）"),
	}
}

// Edges of the User.
func (User) Edges() []ent.Edge {
	return nil
}

// Indexes of the User.
func (User) Indexes() []ent.Index {
	return []ent.Index{
		// public_idにインデックス（外部からの検索用）
		index.Fields("public_id").
			Unique(),
		// firebase_uidにインデックス
		index.Fields("firebase_uid").
			Unique(),
		// emailにインデックス
		index.Fields("email").
			Unique(),
		// deleted_atにインデックス（論理削除の検索用）
		index.Fields("deleted_at"),
	}
}
```

### 手順 2: entコード生成

```bash
cd app
task ent-gen
cd ..
```

生成されるファイル:
- `app/ent/user.go`
- `app/ent/user_create.go`
- `app/ent/user_update.go`
- `app/ent/user_delete.go`
- `app/ent/user_query.go`
- その他entが自動生成するファイル

### 手順 3: migration SQL生成

```bash
cd app
task sql-gen
cd ..
```

生成されるファイル:
- `app/migrations/YYYYMMDDHHMMSS_create_users.sql`

期待されるSQL内容:
```sql
-- create "users" table
CREATE TABLE "users" (
  "id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  "public_id" uuid NOT NULL,
  "firebase_uid" character varying NOT NULL,
  "email" character varying NOT NULL,
  "created_at" timestamptz NOT NULL,
  "updated_at" timestamptz NOT NULL,
  "deleted_at" timestamptz NULL,
  PRIMARY KEY ("id")
);
-- create index "user_public_id" to table: "users"
CREATE UNIQUE INDEX "user_public_id" ON "users" ("public_id");
-- create index "user_firebase_uid" to table: "users"
CREATE UNIQUE INDEX "user_firebase_uid" ON "users" ("firebase_uid");
-- create index "user_email" to table: "users"
CREATE UNIQUE INDEX "user_email" ON "users" ("email");
-- create index "user_deleted_at" to table: "users"
CREATE INDEX "user_deleted_at" ON "users" ("deleted_at");
```

### 手順 4: docs/db_schema.md の更新（必須）

`docs/db_schema.md` に以下を追加:

```markdown
Table users {
  id int [primary key, increment, note: '内部ID（auto increment、外部には公開しない）']
  public_id uuid [not null, unique, note: '公開用ユーザーID（UUID、外部APIで使用）']
  firebase_uid varchar [not null, unique, note: 'Firebase Authentication UID']
  email varchar [not null, unique, note: 'メールアドレス']
  created_at timestamptz [not null, note: '作成日時']
  updated_at timestamptz [not null, note: '更新日時']
  deleted_at timestamptz [null, note: '削除日時（論理削除）']

  indexes {
    public_id [unique, name: 'user_public_id']
    firebase_uid [unique, name: 'user_firebase_uid']
    email [unique, name: 'user_email']
    deleted_at [name: 'user_deleted_at']
  }
}
```

更新履歴に追加:
```markdown
| 更新日 | 作業者 | 変更内容 | 関連Jira |
|------|--------|---------|---------|
| 2025-01-28 | Claude | usersテーブルのID設計を変更（id: uuid -> int auto increment, public_id: uuid追加） | SLEEVE-112 |
| 2025-01-16 | Claude | usersテーブルを追加 | SLEEVE-101 |
```

### 手順 5: マイグレーション実行（開発環境）

```bash
cd app
task migrate-up
cd ..
```

### 手順 6: マイグレーション確認

PostgreSQLに接続してテーブルを確認:
```bash
psql -U youruser -d yourdb -c "\d users"
```

期待される出力:
```
                                   Table "public.users"
    Column     |           Type           |                  Modifiers
---------------+--------------------------+---------------------------------------------
 id            | bigint                   | not null generated by default as identity
 public_id     | uuid                     | not null
 firebase_uid  | character varying        | not null
 email         | character varying        | not null
 created_at    | timestamp with time zone | not null
 updated_at    | timestamp with time zone | not null
 deleted_at    | timestamp with time zone |
Indexes:
    "users_pkey" PRIMARY KEY, btree (id)
    "user_public_id" UNIQUE, btree (public_id)
    "user_firebase_uid" UNIQUE, btree (firebase_uid)
    "user_email" UNIQUE, btree (email)
    "user_deleted_at" btree (deleted_at)
```

---

## ロールバック手順

マイグレーション実行後に問題が発生した場合:

```bash
cd app
task migrate-rollback
cd ..
```

**注意**: 最新の1件のみロールバック可能です。複数件戻す場合は、`ent/schema/user.go`を編集して新しいマイグレーションを生成してください。

---

## セキュリティ考慮事項

### データ保護
- **内部ID（id）**: auto incrementのIDは外部に公開しない。連番から総ユーザー数が推測されることを防ぐ
- **公開ID（public_id）**: UUIDを使用し、外部APIで公開。推測困難で安全
- **Firebase UID**: 不変（Immutable）として定義し、変更を防止
- **Email**: 個人情報のため、適切なアクセス制御が必要
- **論理削除**: 物理削除ではなく論理削除を採用し、削除履歴を保持

### インデックス設計
- **public_id**: ユニークインデックスを設定し、外部からの高速検索と一意性を保証
- **firebase_uid**: ユニークインデックスを設定し、重複を防止
- **email**: ユニークインデックスを設定し、重複を防止

---

## パフォーマンス考慮事項

### インデックス戦略
- `id`（auto increment）: 内部結合時に高速なBツリーインデックス
- `public_id`にユニークインデックス: 外部API経由の検索を高速化
- `firebase_uid`にユニークインデックス: Firebase UIDでの高速検索
- `email`にユニークインデックス: Emailでの検索性能向上

### ID設計によるパフォーマンス改善
- 内部でのJOINやリレーション参照にはintのauto incrementを使用し、インデックスサイズを小さく保つ
- UUIDは外部公開用のみに使用し、内部処理のパフォーマンスを維持

### 将来的な最適化
- ユーザー数が増加した場合、以下を検討:
  - パーティショニング（created_atベース）
  - レプリケーション（読み取り専用レプリカ）
  - キャッシュ層の追加（Redis）

---

## テスト計画

### マイグレーションテスト
- [ ] マイグレーション実行が成功すること
- [ ] usersテーブルが作成されていること
- [ ] 全てのカラムが正しく定義されていること
- [ ] インデックスが正しく設定されていること
- [ ] ロールバックが正常に動作すること

### データ整合性テスト
- [ ] id（auto increment）が自動的にインクリメントされること
- [ ] public_id（UUID）がデータ作成時に自動生成されること
- [ ] public_idにユニーク制約が機能すること
- [ ] firebase_uidにユニーク制約が機能すること
- [ ] emailにユニーク制約が機能すること
- [ ] created_atにデフォルト値（now()）が設定されること
- [ ] 論理削除が正常に動作すること

### ID設計のテスト
- [ ] 外部APIでpublic_idが使用されること（idは公開されないこと）
- [ ] 内部結合でidが正しく使用されること

---

## 承認

この変更計画書を作成したら、作業者に内容の確認を促してください。承認が得られたら、実装を開始してください。

**承認者**: （作業者が記入）
**承認日**: （作業者が記入）
**備考**: （作業者が記入）
