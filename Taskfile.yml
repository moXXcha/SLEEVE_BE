version: "3"

tasks:
  default:
    cmds:
      - echo Hello, World!

  up:
    cmds:
      - echo " ğŸ”¥ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç«‹ã¡ä¸Šã’ã¾ã™... "
      - sleep 2
      - docker compose up -d
      - echo " â¤ï¸â€ğŸ”¥â¤ï¸â€ğŸ”¥ letâ€˜s do it!! â¤ï¸â€ğŸ”¥â¤ï¸â€ğŸ”¥ "

  down:
    cmds:
      - echo " ğŸ¥· ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åœæ­¢ã—ã¾ã™ "
      - sleep 2
      - docker compose down
      - echo " ğŸ’¤ ãŠã‚„ã™ã¿... "

  init:
    cmds:
      - echo " ğŸ”¨ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–ã‚’è¡Œã„ã¾ã™... "
      - sleep 2
      - docker compose down --rmi all --volumes --remove-orphans
      - docker compose up -d
      - echo " âœ… å®Œäº† "

  build:
    cmds:
      - docker compose build

  generate:
    dir: ./app
    cmds:
      - echo " ğŸª„ graphqlã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™... "
      - sleep 2
      - docker exec sleeve-be gqlgen generate
      - echo " ğŸ‰ã§ããŸã§ "

  lint-fmt:
    dir: ./app
    cmds:
      - echo " ğŸ”ªâ¤ï¸ formatã‚’é–‹å§‹ã—ã¾ã™... "
      - sleep 2
      - docker exec sleeve-be golangci-lint run
      - echo " ğŸ”ªğŸ’• å®Œäº† "

  clean:
    desc: "ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã€ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
    cmds:
      - echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™..."
      - sleep 2
      - docker exec sleeve-be sh -c "cd /app && rm -rf tmp/* bin/* dist/*"
      - docker exec sleeve-be sh -c "cd /app && find . -name '*.test' -delete"
      - docker exec sleeve-be sh -c "cd /app && find . -name '*.out' -delete"
      - docker exec sleeve-be sh -c "cd /app && rm -f coverage.txt coverage.html"
      - docker exec sleeve-be sh -c "cd /app && find . -name '*.log' -delete"
      - docker exec sleeve-be sh -c "cd /app && rm -f debug __debug_bin"
      - echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

  clean-all:
    desc: "å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆDockerå«ã‚€ï¼‰"
    cmds:
      - task: clean
      - echo "ğŸ§¹ Dockerãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã™..."
      - sleep 2
      - docker compose down --volumes --remove-orphans
      - docker system prune -f
      - echo "âœ… å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"

  move-app-container:
    desc: "appã‚³ãƒ³ãƒ†ãƒŠã«ç§»å‹•"
    cmds:
      - echo " ğŸšƒ appã‚³ãƒ³ãƒ†ãƒŠã«ç§»å‹•ä¸­... "
      - sleep 2
      - docker exec -it sleeve-be sh
      - echo " ğŸ¤“ ãŠã‹ãˆã‚Š "

  move-db-container:
    desc: "dbã‚³ãƒ³ãƒ†ãƒŠã«ç§»å‹•"
    cmds:
      - echo " ğŸ›º dbã‚³ãƒ³ãƒ†ãƒŠã«ç§»å‹•ä¸­... "
      - sleep 2
      - docker exec -it sleeve-db sh
      - echo " ğŸ¦‘ ãŠã‹ãˆã‚Š "

  sql-gen:
    desc: "migrateç”¨ã®sqlã®ç”Ÿæˆ"
    cmds:
      - echo " ğŸ¦­ sqlç”Ÿæˆä¸­... "
      - |
        docker exec sleeve-be atlas migrate diff \
          --dir "file://./migrate" \
          --to "ent://./ent/schema" \
          --dev-url "postgres://user:password@db:5432/sleeve_db?sslmode=disable"

      - echo " ğŸ€ å®Œäº†ï¼migrateã—ã¦ã­ "

  ent-gen:
    desc: "entã‚³ãƒ¼ãƒ‰ã®generate"
    cmds:
      - echo "entã‚³ãƒ¼ãƒ‰ã®generateã—ã¾ã™..."
      - docker exec sleeve-be go generate ./ent

  migrate-up:
    desc: "migration up"
    cmds:
      - echo " ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¾ã™... "
      - |
        docker exec sleeve-be atlas migrate apply\
          --dir file://./migrate \
          --url "postgres://user:password@db:5432/sleeve_db?sslmode=disable"
      - echo " ğŸ‰æˆåŠŸ "

  migrate-rollback:
    desc: "migration down"
    cmds:
      - echo " migrationã§1ä»¶å·»ãæˆ»ã‚‹ã‚ˆ "
      - docker exec sleeve-db psql -U user -d postgres -c "DROP DATABASE IF EXISTS sleeve_db_dev;"
      - docker exec sleeve-db psql -U user -d postgres -c "CREATE DATABASE sleeve_db_dev;"
      - |
        docker exec sleeve-be atlas migrate down \
          --dir "file://migrate" \
          --url "postgres://user:password@db:5432/sleeve_db?sslmode=disable" \
          --dev-url "postgres://user:password@db:5432/sleeve_db_dev?sslmode=disable"
      - docker exec sleeve-db psql -U user -d postgres -c "DROP DATABASE IF EXISTS sleeve_db_dev;"
      - echo " âª ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº† "
